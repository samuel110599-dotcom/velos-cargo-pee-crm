{% extends "base.html" %}
{% block content %}
<h1>Entreprise</h1>

<form method="post" class="form form--card">
  <h3>Identité</h3>
  <label>Nom de la société *
    <input id="company_name" name="company_name" placeholder="Tapez pour rechercher…">
  </label>
  <div id="suggestions" class="suggestions" style="display:none;"></div>

  <div class="hint">
    <div class="hint-title">SIRET</div>
    <p>Pour trouver un SIRET :
      <a class="chip" id="link-pappers" href="https://www.pappers.fr/recherche" target="_blank" rel="noopener">Pappers</a>
      <a class="chip" id="link-societe" href="https://www.societe.com/" target="_blank" rel="noopener">Societe.com</a>
    </p>
  </div>

  <label>Numéro de SIRET
    <input id="siret" name="siret" placeholder="14 chiffres">
  </label>

  <h3>Signataire</h3>
  <div class="grid">
    <label>Prénom <input id="signer_first_name" name="signer_first_name"></label>
    <label>Nom <input id="signer_last_name" name="signer_last_name"></label>
  </div>
  <label>Rôle dans la société
    <input id="signer_role" name="signer_role" placeholder="Gérant, Président…">
  </label>
  <div class="grid">
    <label>Téléphone <input name="signer_phone" placeholder="+33 …"></label>
    <label>Email <input name="signer_email" type="email" placeholder="prenom@entreprise.fr"></label>
  </div>
  <button type="button" class="btn btn--sm" id="btn-fetch-officers">↺ Remplir automatiquement (dirigeants)</button>

  <h3>Adresses</h3>
  <fieldset class="card soft">
    <legend>Facturation</legend>
    <label>Adresse <input id="billing_address" name="billing_address" placeholder="N° et rue"></label>
    <div class="grid">
      <label>Code postal <input id="billing_zip" name="billing_zip"></label>
      <label>Ville <input id="billing_city" name="billing_city"></label>
    </div>
  </fieldset>

  <label class="inline"><input type="checkbox" id="same_address"> Adresse de livraison = Adresse de facturation</label>

  <fieldset class="card soft">
    <legend>Livraison</legend>
    <label>Adresse <input id="shipping_address" name="shipping_address" placeholder="N° et rue"></label>
    <div class="grid">
      <label>Code postal <input id="shipping_zip" name="shipping_zip"></label>
      <label>Ville <input id="shipping_city" name="shipping_city"></label>
    </div>
  </fieldset>

  <button class="btn btn--primary" type="submit">Créer le dossier</button>
</form>

<script>
/* ================= Helpers ================= */
function onlyDigits(s){ return (s||'').replace(/\D+/g,''); }
function toSirenOrSiret(raw){
  const d = onlyDigits(raw);
  if(d.length >= 14) return { siren: d.slice(0,9), siret: d.slice(0,14) };
  if(d.length >= 9)  return { siren: d.slice(0,9), siret: null };
  return { siren: null, siret: null };
}
function preferOfficer(officers){
  if(!officers || !officers.length) return null;
  const key = (o)=> ((o.fonction||o.qualite||'') + ' ' + (o.role||'')).toLowerCase();
  const pr = ['gérant','gerant','président','president','directeur','dirigeant'];
  for(const p of pr){
    const f = officers.find(o => key(o).includes(p));
    if(f) return f;
  }
  return officers[0];
}

/* ================= Liens externes ================= */
function updateExternalLinks(q){
  const p=document.getElementById('link-pappers');
  const s=document.getElementById('link-societe');
  const qq=encodeURIComponent(q||'');
  p.href='https://www.pappers.fr/recherche?q='+qq;
  s.href='https://www.societe.com/cgi-bin/search?champs='+qq;
}

/* ================= Autocomplete entreprises (API publique) ================= */
const input = document.getElementById('company_name');
const box = document.getElementById('suggestions');
let timer=null;

input.addEventListener('input', ()=>{
  const q=input.value.trim();
  updateExternalLinks(q);
  if(timer) clearTimeout(timer);
  if(q.length<2){ box.style.display='none'; box.innerHTML=''; return; }
  timer=setTimeout(async ()=>{
    try{
      const url='https://recherche-entreprises.api.gouv.fr/search?q='+encodeURIComponent(q)+'&page=1&per_page=6';
      const res=await fetch(url);
      if(!res.ok) throw new Error('API search error');
      const data=await res.json();
      box.innerHTML='';
      (data.results||[]).forEach((e)=>{
        const siege = e.siege || e.etablissement_siege || {};
        const adrObj = siege.adresse || {};
        const name  = e.nom_complet || e.nom_raison_sociale || e.nom || '';
        const siret = siege.siret || e.siret || '';
        const adrText = [adrObj.numero_voie, adrObj.type_voie, adrObj.nom_voie].filter(Boolean).join(' ')
                        || adrObj.voie || '';
        const cp    = siege.code_postal || adrObj.code_postal || '';
        const ville = siege.libelle_commune || adrObj.libelle_commune || '';

        const div=document.createElement('div');
        div.className='suggestion';
        div.innerHTML='<strong>'+name+'</strong>'+(siret? ' — <small>'+siret+'</small>':'');

        div.addEventListener('click', async ()=>{
          input.value=name;
          document.getElementById('siret').value=siret||'';
          document.getElementById('billing_address').value=adrText||'';
          document.getElementById('billing_zip').value=cp||'';
          document.getElementById('billing_city').value=ville||'';
          box.style.display='none'; box.innerHTML='';
          // Auto-dirigeants dès la sélection
          await fillOfficersFromSiretOrSiren(siret);
        });
        box.appendChild(div);
      });
      box.style.display = box.children.length ? 'block' : 'none';
    }catch(e){
      box.style.display='none'; box.innerHTML='';
      console.warn(e);
    }
  },250);
});

/* ================= Récup dirigeants ================= */
async function fetchEntrepriseBySiren(siren){
  const url = 'https://recherche-entreprises.api.gouv.fr/entreprise/'+ encodeURIComponent(siren);
  const res = await fetch(url);
  if(!res.ok) throw new Error('API entreprise error');
  return await res.json();
}

async function fillOfficersFromSiretOrSiren(siretMaybe){
  const raw = siretMaybe || document.getElementById('siret').value || '';
  const {siren} = toSirenOrSiret(raw);
  if(!siren){
    // Si pas de SIRET/SIREN, tenter via le nom (prendre le 1er résultat et relancer)
    const name = document.getElementById('company_name').value.trim();
    if(!name) return;
    try{
      const res = await fetch('https://recherche-entreprises.api.gouv.fr/search?q='+encodeURIComponent(name)+'&page=1&per_page=1');
      if(!res.ok) return;
      const data = await res.json();
      const first = (data.results||[])[0];
      const siege = first && (first.siege || first.etablissement_siege) || {};
      const siret2 = (siege && siege.siret) ? siege.siret : (first && first.siret);
      if(siret2){
        document.getElementById('siret').value = siret2;
        return await fillOfficersFromSiretOrSiren(siret2);
      }
    }catch(e){ console.warn(e); }
    return;
  }
  try{
    const ent = await fetchEntrepriseBySiren(siren);
    const dirs = ent && (ent.dirigeants || (ent.siege && ent.siege.dirigeants) || []);
    if(dirs && dirs.length){
      const d = preferOfficer(dirs);
      if(d){
        const prenom = (d.prenom || d.prenoms || '').toString().split(' ')[0] || '';
        document.getElementById('signer_first_name').value = prenom;
        document.getElementById('signer_last_name').value  = d.nom || '';
        document.getElementById('signer_role').value       = d.fonction || d.qualite || d.role || '';
      }
    }
  }catch(e){ console.warn(e); }
}

document.getElementById('btn-fetch-officers').addEventListener('click', ()=> fillOfficersFromSiretOrSiren());

/* ================= Copier facturation -> livraison ================= */
document.getElementById('same_address').addEventListener('change', (ev)=>{
  if(ev.target.checked){
    document.getElementById('shipping_address').value = document.getElementById('billing_address').value;
    document.getElementById('shipping_zip').value     = document.getElementById('billing_zip').value;
    document.getElementById('shipping_city').value    = document.getElementById('billing_city').value;
  }
});
</script>

<style>
.suggestions{border:1px solid #e5e7eb;border-radius:10px;margin-top:-6px;margin-bottom:10px;overflow:hidden;background:#fff;max-width:700px}
.suggestion{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9}
.suggestion:last-child{border-bottom:none}
.suggestion:hover{background:#f8fafc}
.hint{border:1px dashed #cbd5e1;background:#f8fafc;border-radius:12px;padding:10px 12px;margin:8px 0 10px}
.hint-title{font-weight:700;margin-bottom:6px}
.chip{display:inline-block;padding:6px 10px;border-radius:999px;background:#e8fff2;border:1px solid #86efac;margin-left:6px}
.inline{display:flex;align-items:center;gap:8px;margin:12px 0}
.form--card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px}
</style>
{% endblock %}
