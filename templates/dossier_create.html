{% extends "base.html" %}
{% block content %}
<h1>Entreprise</h1>

<form method="post" class="form form--card">
  <h3>Identité</h3>
  <label>Nom de la société *
    <input id="company_name" name="company_name" placeholder="Tapez pour rechercher…">
  </label>
  <div id="suggestions" class="suggestions" style="display:none;"></div>

  <label>Numéro de SIRET
    <input id="siret" name="siret" placeholder="14 chiffres">
  </label>

  <h3>Signataire</h3>
  <div class="grid">
    <label>Prénom <input id="signer_first_name" name="signer_first_name"></label>
    <label>Nom <input id="signer_last_name" name="signer_last_name"></label>
  </div>
  <label>Rôle dans la société
    <input id="signer_role" name="signer_role" placeholder="Gérant, Président…">
  </label>
  <div class="grid">
    <label>Téléphone <input name="signer_phone" placeholder="+33 …"></label>
    <label>Email <input name="signer_email" type="email" placeholder="prenom@entreprise.fr"></label>
  </div>
  <button type="button" class="btn btn--sm" id="btn-fetch-officers">↺ Remplir automatiquement (dirigeants)</button>

  <h3>Adresses</h3>
  <fieldset class="card soft">
    <legend>Facturation</legend>
    <label>Adresse <input id="billing_address" name="billing_address"></label>
    <div class="grid">
      <label>Code postal <input id="billing_zip" name="billing_zip"></label>
      <label>Ville <input id="billing_city" name="billing_city"></label>
    </div>
  </fieldset>

  <label class="inline"><input type="checkbox" id="same_address"> Adresse de livraison = Adresse de facturation</label>

  <fieldset class="card soft">
    <legend>Livraison</legend>
    <label>Adresse <input id="shipping_address" name="shipping_address"></label>
    <div class="grid">
      <label>Code postal <input id="shipping_zip" name="shipping_zip"></label>
      <label>Ville <input id="shipping_city" name="shipping_city"></label>
    </div>
  </fieldset>

  <button class="btn btn--primary" type="submit">Créer le dossier</button>
</form>

<script>
/* Helpers */
function onlyDigits(s){ return (s||'').replace(/\\D+/g,''); }
function toSiren(raw){
  const d = onlyDigits(raw||'');
  if(d.length >= 9) return d.slice(0,9);
  return null;
}
function preferOfficer(officers){
  if(!officers || !officers.length) return null;
  const key = (o)=> ((o.fonction||o.qualite||o.role||'')+'').toLowerCase();
  const pr = ['gérant','gerant','président','president','directeur','dirigeant'];
  for(const p of pr){ const f = officers.find(o => key(o).includes(p)); if(f) return f; }
  return officers[0];
}

/* Autocomplete entreprises */
const input = document.getElementById('company_name');
const box = document.getElementById('suggestions');
let timer=null;

input.addEventListener('input', ()=>{
  const q=input.value.trim();
  if(timer) clearTimeout(timer);
  if(q.length<2){ box.style.display='none'; box.innerHTML=''; return; }
  timer=setTimeout(async ()=>{
    try{
      const url='https://recherche-entreprises.api.gouv.fr/search?q='+encodeURIComponent(q)+'&page=1&per_page=6';
      const res=await fetch(url);
      if(!res.ok) throw new Error('API search error');
      const data=await res.json();
      box.innerHTML='';
      (data.results||[]).forEach((e)=>{
        const name=e.nom_complet||e.nom||'';
        const siret=(e.siege && e.siege.siret)? e.siege.siret : (e.siret||'');
        const adr=e.siege?.adresse||''; const cp=e.siege?.code_postal||''; const ville=e.siege?.libelle_commune||'';
        const div=document.createElement('div'); div.className='suggestion';
        div.innerHTML='<strong>'+name+'</strong>'+(siret? ' — <small>'+siret+'</small>':'');
        div.addEventListener('click', async ()=>{
          input.value=name;
          document.getElementById('siret').value=siret||'';
          document.getElementById('billing_address').value=adr||'';
          document.getElementById('billing_zip').value=cp||'';
          document.getElementById('billing_city').value=ville||'';
          box.style.display='none'; box.innerHTML='';
          await fillOfficersPublic(siret,name);
        });
        box.appendChild(div);
      });
      box.style.display = box.children.length ? 'block' : 'none';
    }catch(e){ box.style.display='none'; box.innerHTML=''; }
  },250);
});

/* Récup dirigeants via API publique */
async function fetchEntrepriseBySiren(siren){
  const res = await fetch('https://recherche-entreprises.api.gouv.fr/entreprise/'+encodeURIComponent(siren));
  if(!res.ok) throw new Error('API entreprise error');
  return await res.json();
}
async function fillOfficersPublic(siretMaybe, nameMaybe){
  let siren = toSiren(siretMaybe);
  try{
    if(!siren && nameMaybe){
      const res = await fetch('https://recherche-entreprises.api.gouv.fr/search?q='+encodeURIComponent(nameMaybe)+'&page=1&per_page=1');
      if(res.ok){
        const data = await res.json();
        const first = (data.results||[])[0];
        if(first){
          const siret2 = first.siege?.siret || first.siret || '';
          siren = toSiren(siret2);
          if(siret2 && !document.getElementById('siret').value){
            document.getElementById('siret').value = siret2;
          }
        }
      }
    }
    if(!siren) return;
    const d2 = await fetchEntrepriseBySiren(siren);
    const dirs = d2.dirigeants || d2.siege?.dirigeants || [];
    if(dirs.length){
      const d = preferOfficer(dirs);
      if(d){
        document.getElementById('signer_first_name').value = (d.prenom||d.prenoms||'').split(' ')[0]||'';
        document.getElementById('signer_last_name').value  = d.nom||'';
        document.getElementById('signer_role').value       = d.fonction||d.qualite||d.role||'';
      }
    }
  }catch(e){ console.warn(e); }
}

/* Bouton manuel */
document.getElementById('btn-fetch-officers').addEventListener('click', async () => {
  const siret = (document.getElementById('siret').value||'').replace(/\\D+/g,'');
  const name  = document.getElementById('company_name').value.trim();
  await fillOfficersPublic(siret, name);
});

/* Copier facturation -> livraison */
document.getElementById('same_address').addEventListener('change', (ev)=>{
  if(ev.target.checked){
    document.getElementById('shipping_address').value = document.getElementById('billing_address').value;
    document.getElementById('shipping_zip').value     = document.getElementById('billing_zip').value;
    document.getElementById('shipping_city').value    = document.getElementById('billing_city').value;
  }
});
</script>

<style>
.suggestions{border:1px solid #e5e7eb;border-radius:10px;margin-top:-6px;margin-bottom:10px;overflow:hidden;background:#fff;max-width:700px}
.suggestion{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9}
.suggestion:hover{background:#f8fafc}
.inline{display:flex;align-items:center;gap:8px;margin:12px 0}
.form--card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px}
</style>
{% endblock %}
