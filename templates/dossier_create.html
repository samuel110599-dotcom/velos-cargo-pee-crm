{% extends "base.html" %}
{% block content %}
<h1>Entreprise</h1>

<form method="post" class="form form--card">
  <h3>Identit√©</h3>
  <label>Nom de la soci√©t√© *
    <input id="company_name" name="company_name" placeholder="Tapez pour rechercher‚Ä¶">
  </label>
  <div id="suggestions" class="suggestions" style="display:none;"></div>

  <label>Num√©ro de SIRET
    <input id="siret" name="siret" placeholder="14 chiffres">
  </label>

  <h3>Signataire</h3>
  <div class="grid">
    <label>Pr√©nom <input id="signer_first_name" name="signer_first_name"></label>
    <label>Nom <input id="signer_last_name" name="signer_last_name"></label>
  </div>
  <label>R√¥le dans la soci√©t√©
    <input id="signer_role" name="signer_role" placeholder="G√©rant, Pr√©sident‚Ä¶">
  </label>
  <div class="grid">
    <label>T√©l√©phone <input name="signer_phone" placeholder="+33 ‚Ä¶"></label>
    <label>Email <input name="signer_email" type="email" placeholder="prenom@entreprise.fr"></label>
  </div>

  <!-- Beau bouton -->
  <div class="actions">
    <button type="button" class="btn btn--primary" id="btn-fetch-officers">
      <span class="btn__spinner" id="btn-spin" style="display:none;">‚è≥</span>
      üîé Remplir automatiquement (dirigeants)
    </button>
    <span id="status" class="status"></span>
  </div>

  <h3>Adresses</h3>
  <fieldset class="card soft">
    <legend>Facturation</legend>
    <label>Adresse <input id="billing_address" name="billing_address"></label>
    <div class="grid">
      <label>Code postal <input id="billing_zip" name="billing_zip"></label>
      <label>Ville <input id="billing_city" name="billing_city"></label>
    </div>
  </fieldset>

  <label class="inline"><input type="checkbox" id="same_address"> Adresse de livraison = Adresse de facturation</label>

  <fieldset class="card soft">
    <legend>Livraison</legend>
    <label>Adresse <input id="shipping_address" name="shipping_address"></label>
    <div class="grid">
      <label>Code postal <input id="shipping_zip" name="shipping_zip"></label>
      <label>Ville <input id="shipping_city" name="shipping_city"></label>
    </div>
  </fieldset>

  <button class="btn btn--primary" type="submit">Cr√©er le dossier</button>
</form>

<script>
/* ===== Helpers ===== */
function digits(s){ return (s||'').replace(/\D+/g,''); }
function sirenFrom(any){ const d=digits(any||''); return d.length>=9 ? d.slice(0,9) : null; }
function preferOfficer(list){
  if(!list || !list.length) return null;
  const key=o=>((o.fonction||o.qualite||o.role||'')+'').toLowerCase();
  const pr=['g√©rant','gerant','pr√©sident','president','directeur','dirigeant'];
  for(const p of pr){ const f=list.find(o=>key(o).includes(p)); if(f) return f; }
  return list[0];
}
function setStatus(msg, ok=true){
  const el=document.getElementById('status');
  el.textContent=msg||'';
  el.className='status ' + (ok?'ok':'err');
}

/* ===== Autocomplete (API publique) ===== */
const input = document.getElementById('company_name');
const box = document.getElementById('suggestions');
let timer=null;

input.addEventListener('input', ()=>{
  const q=input.value.trim();
  if(timer) clearTimeout(timer);
  if(q.length<2){ box.style.display='none'; box.innerHTML=''; return; }
  timer=setTimeout(async ()=>{
    try{
      const res=await fetch('https://recherche-entreprises.api.gouv.fr/search?q='+encodeURIComponent(q)+'&page=1&per_page=6');
      if(!res.ok) throw new Error('API search');
      const data=await res.json();
      box.innerHTML='';
      (data.results||[]).forEach(e=>{
        const name=e.nom_complet||e.nom_raison_sociale||e.nom||'';
        const siret=(e.siege && e.siege.siret)? e.siege.siret : (e.siret||'');
        const adr=e.siege?.adresse||''; const cp=e.siege?.code_postal||''; const ville=e.siege?.libelle_commune||'';
        const div=document.createElement('div'); div.className='suggestion';
        div.innerHTML='<strong>'+name+'</strong>'+(siret?' ‚Äî <small>'+siret+'</small>':'');
        div.addEventListener('click', async ()=>{
          input.value=name;
          document.getElementById('siret').value=siret||'';
          document.getElementById('billing_address').value=adr||'';
          document.getElementById('billing_zip').value=cp||'';
          document.getElementById('billing_city').value=ville||'';
          box.style.display='none'; box.innerHTML='';
          await autoFillOfficers(siret, name);  // auto-direct
        });
        box.appendChild(div);
      });
      box.style.display = box.children.length ? 'block' : 'none';
    }catch(e){ box.style.display='none'; box.innerHTML=''; }
  }, 250);
});

/* ===== Dirigeants via API publique ===== */
async function getEntrepriseBySiren(siren){
  const r = await fetch('https://recherche-entreprises.api.gouv.fr/entreprise/'+encodeURIComponent(siren));
  if(!r.ok) throw new Error('API entreprise');
  return await r.json();
}
async function autoFillOfficers(siretMaybe, nameMaybe){
  setStatus('', true);
  const btn=document.getElementById('btn-fetch-officers');
  const spin=document.getElementById('btn-spin');
  btn.disabled=true; spin.style.display='inline-block';

  try{
    let siren = sirenFrom(siretMaybe);
    // si pas siren ‚Üí rechercher 1er r√©sultat par nom
    if(!siren && nameMaybe){
      const rs = await fetch('https://recherche-entreprises.api.gouv.fr/search?q='+encodeURIComponent(nameMaybe)+'&page=1&per_page=1');
      if(rs.ok){
        const d = await rs.json();
        const first = (d.results||[])[0];
        if(first){
          const siret2 = first.siege?.siret || first.siret || '';
          if(siret2 && !document.getElementById('siret').value){
            document.getElementById('siret').value = siret2;
          }
          siren = sirenFrom(siret2);
        }
      }
    }
    if(!siren){ setStatus("Aucun SIREN trouv√©.", false); return; }

    const ent = await getEntrepriseBySiren(siren);
    const dirs = ent.dirigeants || ent.siege?.dirigeants || [];
    if(!dirs.length){ setStatus("Aucun dirigeant trouv√©.", false); return; }

    const d = preferOfficer(dirs);
    document.getElementById('signer_first_name').value = (d.prenom||d.prenoms||'').split(' ')[0]||'';
    document.getElementById('signer_last_name').value  = d.nom||'';
    document.getElementById('signer_role').value       = d.fonction||d.qualite||d.role||'';

    setStatus("Dirigeant rempli automatiquement ‚úÖ", true);
  }catch(e){
    setStatus("Erreur de r√©cup√©ration.", false);
  }finally{
    btn.disabled=false; spin.style.display='none';
  }
}

/* Bouton manuel */
document.getElementById('btn-fetch-officers').addEventListener('click', async ()=>{
  const siret = document.getElementById('siret').value;
  const name  = document.getElementById('company_name').value.trim();
  await autoFillOfficers(siret, name);
});

/* Copier facturation -> livraison */
document.getElementById('same_address').addEventListener('change', (ev)=>{
  if(ev.target.checked){
    document.getElementById('shipping_address').value = document.getElementById('billing_address').value;
    document.getElementById('shipping_zip').value     = document.getElementById('billing_zip').value;
    document.getElementById('shipping_city').value    = document.getElementById('billing_city').value;
  }
});
</script>

<style>
/* bouton + status (s'adosse au style global .btn/.btn--primary d√©j√† pr√©sent) */
.actions{display:flex;align-items:center;gap:12px;margin:10px 0 4px}
.status{font-size:14px}
.status.ok{color:#047857}
.status.err{color:#b91c1c}
.btn__spinner{margin-right:6px}

/* suggestions de l'autocomplete */
.suggestions{border:1px solid #e5e7eb;border-radius:10px;margin-top:-6px;margin-bottom:10px;overflow:hidden;background:#fff;max-width:700px}
.suggestion{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9}
.suggestion:last-child{border-bottom:none}
.suggestion:hover{background:#f8fafc}

/* carte formulaire */
.form--card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px}
.inline{display:flex;align-items:center;gap:8px;margin:12px 0}
</style>
{% endblock %}
